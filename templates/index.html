{% extends 'base.html' %}
{% block content %}
{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

<div class="panel">
<h2>Subnets</h2>
<table class="table table-striped mb-0">
  <thead>
    <tr><th>CIDR</th><th>Name</th><th>Hosts</th><th>Actions</th></tr>
  </thead>
  <tbody>
  {% for subnet in subnets or [] %}
    <tr>
      <td>{{ subnet.cidr }}</td>
      <td>
        <span class="js-subnet-name" data-id="{{ subnet.id }}">{{ subnet.name }}</span>
        <button type="button" class="btn btn-sm btn-outline-secondary ms-2 js-edit-subnet" data-id="{{ subnet.id }}" title="Edit name" aria-label="Edit name">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-9.5 9.5a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l9.5-9.5zM11.207 2 14 4.793 12.5 6.293 9.707 3.5 11.207 2zM8.5 4.707 11.293 7.5 4 14.793V12h-2.793L8.5 4.707z"/></svg>
        </button>
        <form method="post" action="/subnets/{{ subnet.id }}/rename" class="d-none mt-2 js-subnet-edit" data-id="{{ subnet.id }}">
          <div class="input-group input-group-sm" style="max-width: 420px;">
            <input class="form-control" name="name" value="{{ subnet.name }}" required>
            <button class="btn btn-success" type="submit" title="Save" aria-label="Save">
              ✓
            </button>
            <button class="btn btn-outline-secondary js-cancel-edit-subnet" type="button" data-id="{{ subnet.id }}" title="Cancel" aria-label="Cancel">×</button>
          </div>
        </form>
      </td>
      <td>{{ subnet_up_counts.get(subnet.id, 0) }}</td>
      <td>
        <div class="d-flex gap-2">
          <form method="post" action="/subnets/{{ subnet.id }}/scan">
            <button class="btn btn-sm btn-outline-primary" title="Scan now" aria-label="Scan now">Scan</button>
          </form>
          <form method="post" action="/subnets/{{ subnet.id }}/delete" onsubmit="return confirm('Delete this subnet? Hosts will be detached.');">
            <button class="btn btn-sm btn-outline-danger" title="Delete subnet" aria-label="Delete subnet">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V6H6v7.5a.5.5 0 0 1-1 0v-8z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2H5h6h2.5a1 1 0 0 1 1 1zM5 4v9h6V4H5zM4.118 2 4 2.059V2h8v.059L11.882 2H4.118z"/></svg>
            </button>
          </form>
        </div>
      </td>
    </tr>
  {% endfor %}
  </tbody>
  {% if not subnets or subnets|length == 0 %}
  <tfoot>
    <tr><td colspan="3" class="text-muted">No subnets yet</td></tr>
  </tfoot>
  {% endif %}
</table>
</div>

<!-- Controls between Subnets and Hosts -->
<div class="panel p-3">
  <div class="row g-3 align-items-end">
    <!-- Add Subnet -->
    <div class="col-md-8">
      <form method="post" action="/subnets" class="row g-2">
        <div class="col-md-5">
          <input class="form-control" name="cidr" placeholder="CIDR (e.g., 10.0.0.0/24)" required>
        </div>
        <div class="col-md-5">
          <input class="form-control" name="name" placeholder="Name" required>
        </div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-outline-info" type="submit">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14z"/>
              <path d="M8 4a.5.5 0 0 1 .5.5V7.5H11.5a.5.5 0 0 1 0 1H8.5V11.5a.5.5 0 0 1-1 0V8.5H4.5a.5.5 0 0 1 0-1H7.5V4.5A.5.5 0 0 1 8 4z"/>
            </svg>
            Add Subnet
          </button>
        </div>
      </form>
      <div class="form-text">CIDR is validated and deduplicated.</div>
    </div>
    <!-- Add Reservation -->
    <div class="col-md-4">
      <form method="post" action="/hosts" class="row g-2">
        <div class="col">
          <input class="form-control" name="ip" placeholder="Reserve IP (e.g., 10.0.0.10)" required>
        </div>
        <div class="col-auto d-grid">
          <button class="btn btn-outline-info" type="submit">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14z"/>
              <path d="M8 4a.5.5 0 0 1 .5.5V7.5H11.5a.5.5 0 0 1 0 1H8.5V11.5a.5.5 0 0 1-1 0V8.5H4.5a.5.5 0 0 1 0-1H7.5V4.5A.5.5 0 0 1 8 4z"/>
            </svg>
            Add Reservation
          </button>
        </div>
      </form>
      <div class="form-text mt-1">Reservations auto-link to the most specific matching subnet.</div>
    </div>
  </div>
  
  </div>

<div class="panel">
<h2>Hosts</h2>

{# Build list of other (no subnet) hosts #}
{% set other_hosts = hosts|selectattr('subnet_id', 'equalto', None)|list %}

{# Mobile: compact select for tabs #}
<div class="d-md-none mb-2">
  {% set has_subnets = (subnets and (subnets|length > 0)) %}
  <select id="hostTabSelect" class="form-select form-select-sm">
    {% for subnet in subnets or [] %}
      {% set count = subnet.hosts|length %}
      <option value="#pane-{{ subnet.id }}" {% if loop.first %}selected{% endif %}>{{ subnet.name }} {{ subnet_up_counts.get(subnet.id, 0) }}</option>
    {% endfor %}
    <option value="#pane-other" {% if not has_subnets %}selected{% endif %}>Other ({{ other_hosts|length }})</option>
  </select>
</div>

<div class="d-none d-md-flex align-items-end justify-content-between mb-2">
  <div class="tab-scroll flex-grow-1 min-w-0" style="white-space: nowrap;">
    <ul class="nav nav-tabs flex-nowrap" id="hostTabs" role="tablist">
      {% for subnet in subnets or [] %}
        {% set count = subnet.hosts|length %}
        <li class="nav-item" role="presentation">
          <a class="nav-link {% if loop.first %}active{% endif %}" id="tab-{{ subnet.id }}" data-bs-toggle="tab" href="#pane-{{ subnet.id }}" role="tab" aria-controls="pane-{{ subnet.id }}" aria-selected="{{ 'true' if loop.first else 'false' }}" title="{{ subnet.name }}">
            <span class="tab-label">{{ subnet.name }}</span>
            <span class="badge bg-secondary ms-1">{{ subnet_up_counts.get(subnet.id, 0) }}</span>
          </a>
        </li>
      {% endfor %}
      <li class="nav-item" role="presentation">
        {% set no_subnets = (not subnets or (subnets|length == 0)) %}
        <a class="nav-link {% if no_subnets %}active{% endif %}" id="tab-other" data-bs-toggle="tab" href="#pane-other" role="tab" aria-controls="pane-other" aria-selected="{{ 'true' if no_subnets else 'false' }}" title="Other">
          <span class="tab-label">Other</span>
          <span class="badge bg-secondary ms-1">{{ other_hosts|length }}</span>
        </a>
      </li>
    </ul>
  </div>
  <div class="tab-global-actions text-nowrap ms-2">
    {# One form per tab; JS shows the one matching active tab #}
    {% for subnet in subnets or [] %}
    <form class="d-inline tab-action {% if not loop.first %}d-none{% endif %}" data-target="#pane-{{ subnet.id }}" method="post" action="/subnets/{{ subnet.id }}/scan_ports">
      <button class="btn btn-sm btn-outline-info">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1"><path d="M10.442 10.442a1 1 0 0 1 1.415 0l3.9 3.9a1 1 0 0 1-1.414 1.415l-3.9-3.9a1 1 0 0 1 0-1.415z"/><path d="M6.5 12a5.5 5.5 0 1 1 0-11 5.5 5.5 0 0 1 0 11zm0-1A4.5 4.5 0 1 0 6.5 2a4.5 4.5 0 0 0 0 9z"/></svg>
        Scan Ports (All)
      </button>
    </form>
    {% endfor %}
    <form class="d-inline tab-action {% if subnets and (subnets|length > 0) %}d-none{% endif %}" data-target="#pane-other" method="post" action="/subnets/0/scan_ports">
      <button class="btn btn-sm btn-outline-info">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1"><path d="M10.442 10.442a1 1 0 0 1 1.415 0l3.9 3.9a1 1 0 0 1-1.414 1.415l-3.9-3.9a1 1 0 0 1 0-1.415z"/><path d="M6.5 12a5.5 5.5 0 1 1 0-11 5.5 5.5 0 0 1 0 11zm0-1A4.5 4.5 0 1 0 6.5 2a4.5 4.5 0 0 0 0 9z"/></svg>
        Scan Ports (All)
      </button>
    </form>
  </div>
</div>

<div class="tab-content p-3">
  {% for subnet in subnets or [] %}
  <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="pane-{{ subnet.id }}" role="tabpanel" aria-labelledby="tab-{{ subnet.id }}">
    {# per-pane action moved to tab-global-actions #}
    <table class="table table-striped">
      <thead>
        <tr>
          <th>IP</th>
          <th>Hostname</th>
          <th>MAC</th>
          <th class="text-center">Status</th>
          <th class="text-end">Latency ms</th>
          <th class="text-center">Flags</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for host in hosts if host.subnet_id == subnet.id %}
        {% set last = host.statuses[0] if host.statuses else None %}
        {% set is_reserved = (host.tags_json and 'reserved' in host.tags_json) %}
        {% if is_reserved or (last and last.is_up) %}
        <tr>
      <td>
        {% set tip = port_summaries.get(host.id) if port_summaries else None %}
        {% if tip %}
          <span class="pill-ip" role="button" tabindex="0" aria-label="Copy IP" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ tip }}">{{ host.ip }}</span>
        {% else %}
          <span class="pill-ip" role="button" tabindex="0" aria-label="Copy IP">{{ host.ip }}</span>
        {% endif %}
      </td>
      <td>
        {% if host.hostname %}
          {{ host.hostname }}
        {% else %}
          <form method="post" action="/hosts/{{ host.id }}/hostname" class="d-flex gap-2">
            <input class="form-control form-control-sm" name="hostname" placeholder="Set hostname" required>
            <button class="btn btn-sm btn-outline-secondary" type="submit">Save</button>
          </form>
        {% endif %}
      </td>
      <td>
        <div class="js-mac-display" data-id="{{ host.id }}">
          {% if host.mac %}
            <code class="small js-copy-mac" role="button" title="Click to copy">{{ host.mac }}</code>
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </div>
        <div class="d-none js-mac-edit mt-1" data-id="{{ host.id }}">
          <div class="input-group input-group-sm" style="max-width: 360px;">
            <form method="post" action="/hosts/{{ host.id }}/mac" class="d-flex w-100 me-1">
              <input class="form-control font-monospace" name="mac" placeholder="AA:BB:CC:DD:EE:FF" value="{{ host.mac or '' }}" required>
              <button class="btn btn-outline-secondary ms-2" type="submit">Save</button>
            </form>
            <form method="post" action="/hosts/{{ host.id }}/mac/clear" onsubmit="return confirm('Clear MAC?');">
              <button class="btn btn-sm btn-outline-danger p-0 px-1" title="Delete MAC" aria-label="Delete MAC">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V6H6v7.5a.5.5 0 0 1-1 0v-8z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2H5h6h2.5a1 1 0 0 1 1 1zM5 4v9h6V4H5zM4.118 2 4 2.059V2h8v.059L11.882 2H4.118z"/></svg>
              </button>
            </form>
            <button class="btn btn-outline-secondary js-cancel-mac ms-1" type="button">×</button>
          </div>
        </div>
      </td>
          <td class="text-center">
            {% if last %}
              {% set ts = last.ts.strftime('%Y-%m-%d %H:%M:%S UTC') %}
              {% if last.is_up %}
                <span class="badge bg-success" data-bs-toggle="tooltip" title="Up: host responded to ping. Last checked: {{ ts }}">Up</span>
              {% else %}
                <span class="badge bg-danger" data-bs-toggle="tooltip" title="Down: no ping response. Last checked: {{ ts }}">Down</span>
              {% endif %}
            {% else %}
              <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Unknown: no checks yet">Unknown</span>
            {% endif %}
          </td>
      <td>{{ '%.1f'|format(last.latency_ms) if last and last.latency_ms else '' }}</td>
      <td class="text-end">
        {% set is_reserved = (host.tags_json and 'reserved' in host.tags_json) %}
        {% set has_ports = (port_summaries and port_summaries.get(host.id)) %}
        {% set is_deprecated = (host.tags_json and 'deprecated' in host.tags_json) %}
        {% if is_reserved %}
          <span class="badge text-dark" data-flag="reserved" data-bs-toggle="tooltip" title="Address reserved">R</span>
        {% endif %}
        {% if has_ports %}
          <span class="badge text-dark ms-1" data-flag="ports" data-bs-toggle="tooltip" title="Ports: open ports were found">P</span>
        {% endif %}
        {% if is_deprecated %}
          <span class="badge text-light ms-1" data-flag="deprecated" data-bs-toggle="tooltip" title="Deprecated: host marked for removal">D</span>
        {% endif %}
      </td>
      <td class="text-end">
        <div class="d-flex justify-content-end align-items-center gap-1 flex-wrap">
          <!-- Scan ports: always visible -->
          <form method="post" action="/hosts/{{ host.id }}/scan_ports" class="d-inline" title="Scan ports" aria-label="Scan ports">
            <button class="btn btn-sm btn-outline-info p-0 px-1" type="submit">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M10.442 10.442a1 1 0 0 1 1.415 0l3.9 3.9a1 1 0 0 1-1.414 1.415l-3.9-3.9a1 1 0 0 1 0-1.415z"/><path d="M6.5 12a5.5 5.5 0 1 1 0-11 5.5 5.5 0 0 1 0 11zm0-1A4.5 4.5 0 1 0 6.5 2a4.5 4.5 0 0 0 0 9z"/></svg>
            </button>
          </form>

          <!-- Clear Name: always visible but disabled when no hostname -->
          <form method="post" action="/hosts/{{ host.id }}/hostname/clear" class="d-inline" title="Clear hostname" aria-label="Clear hostname">
            <button class="btn btn-sm btn-outline-secondary" {% if not host.hostname %}disabled aria-disabled="true"{% endif %}>Clear Name</button>
          </form>

          <!-- Unreserve: always visible but disabled when not reserved -->
          <form method="post" action="/hosts/{{ host.id }}/unreserve" class="d-inline" title="Unreserve" aria-label="Unreserve">
            <button class="btn btn-sm btn-outline-danger" {% if not is_reserved %}disabled aria-disabled="true"{% endif %}>
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V6H6v7.5a.5.5 0 0 1-1 0v-8z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2H5h6h2.5a1 1 0 0 1 1 1zM5 4v9h6V4H5zM4.118 2 4 2.059V2h8v.059L11.882 2H4.118z"/></svg>
            </button>
          </form>
          {# Removal is handled via Unreserve when host is down; no separate Remove button #}
          <!-- Deprecation toggle: text + color reflect current state -->
          {% set is_deprecated = (host.tags_json and 'deprecated' in host.tags_json) %}
          <form method="post" action="/hosts/{{ host.id }}/{% if is_deprecated %}undeprecate{% else %}deprecate{% endif %}" class="d-inline" title="{% if is_deprecated %}Revive{% else %}Retire{% endif %}" aria-label="{% if is_deprecated %}Revive{% else %}Retire{% endif %}">
            <button class="btn btn-sm {% if is_deprecated %}btn-outline-info{% else %}btn-outline-dark{% endif %}">
              {% if is_deprecated %}
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1"><path d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm10.97-2.03a.75.75 0 0 1 1.06 1.06L7.525 12.53a.75.75 0 0 1-1.08.02L3.525 9.62a.75.75 0 1 1 1.06-1.06l2.18 2.18 5.206-5.77z"/></svg>
                Revive
              {% else %}
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1"><path d="M8.982 1.566a1.5 1.5 0 0 0-1.964 0l-6 5.5A1.5 1.5 0 0 0 1.5 10h13a1.5 1.5 0 0 0 1.482-2.934l-6-5.5z"/></svg>
                Retire
              {% endif %}
            </button>
          </form>
          <!-- Edit MAC toggle: always visible -->
          <button type="button" class="btn btn-sm btn-outline-secondary p-0 px-1 js-toggle-mac" data-id="{{ host.id }}" title="Edit MAC" aria-label="Edit MAC">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-9.5 9.5a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l9.5-9.5zM11.207 2 14 4.793 12.5 6.293 9.707 3.5 11.207 2zM8.5 4.707 11.293 7.5 4 14.793V12h-2.793L8.5 4.707z"/></svg>
          </button>
        </div>
      </td>
        </tr>
      {% endif %}
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% endfor %}
  <div class="tab-pane fade {% if not subnets or (subnets|length == 0) %}show active{% endif %}" id="pane-other" role="tabpanel" aria-labelledby="tab-other">
    {# per-pane action moved to tab-global-actions #}
    <table class="table table-striped">
      <thead>
        <tr><th>IP</th><th>Hostname</th><th>MAC</th><th>Status</th><th>Latency ms</th><th>Flags</th><th>Actions</th></tr>
      </thead>
      <tbody>
      {% for host in hosts if not host.subnet_id %}
        {% set last = host.statuses[0] if host.statuses else None %}
        <tr>
          {% set tip = port_summaries.get(host.id) if port_summaries else None %}
          {% if tip %}
            <td><span class="pill-ip" role="button" tabindex="0" aria-label="Copy IP" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ tip }}">{{ host.ip }}</span></td>
          {% else %}
            <td><span class="pill-ip" role="button" tabindex="0" aria-label="Copy IP">{{ host.ip }}</span></td>
          {% endif %}
          <td>
            {% if host.hostname %}
              {{ host.hostname }}
            {% else %}
              <form method="post" action="/hosts/{{ host.id }}/hostname" class="d-flex gap-2">
                <input class="form-control form-control-sm" name="hostname" placeholder="Set hostname" required>
                <button class="btn btn-sm btn-outline-secondary" type="submit">Save</button>
              </form>
            {% endif %}
          </td>
          <td>
            <div class="js-mac-display" data-id="{{ host.id }}">
              {% if host.mac %}
                <code class="small js-copy-mac" role="button" title="Click to copy">{{ host.mac }}</code>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </div>
            <div class="d-none js-mac-edit mt-1" data-id="{{ host.id }}">
              <div class="input-group input-group-sm" style="max-width: 360px;">
                <form method="post" action="/hosts/{{ host.id }}/mac" class="d-flex w-100 me-1">
                  <input class="form-control font-monospace" name="mac" placeholder="AA:BB:CC:DD:EE:FF" value="{{ host.mac or '' }}" required>
                  <button class="btn btn-outline-secondary ms-2" type="submit">Save</button>
                </form>
                <form method="post" action="/hosts/{{ host.id }}/mac/clear" onsubmit="return confirm('Clear MAC?');">
                  <button class="btn btn-sm btn-outline-danger p-0 px-1" title="Delete MAC" aria-label="Delete MAC">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V6H6v7.5a.5.5 0 0 1-1 0v-8z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2H5h6h2.5a1 1 0 0 1 1 1zM5 4v9h6V4H5zM4.118 2 4 2.059V2h8v.059L11.882 2H4.118z"/></svg>
              </button>
                </form>
                <button class="btn btn-outline-secondary js-cancel-mac ms-1" type="button">×</button>
              </div>
            </div>
          </td>
          <td>
            {% if last %}
              {% set ts = last.ts.strftime('%Y-%m-%d %H:%M:%S UTC') %}
              {% if last.is_up %}
                <span class="badge bg-success" data-bs-toggle="tooltip" title="Up: host responded to ping. Last checked: {{ ts }}">Up</span>
              {% else %}
                <span class="badge bg-danger" data-bs-toggle="tooltip" title="Down: no ping response. Last checked: {{ ts }}">Down</span>
              {% endif %}
            {% else %}
              <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Unknown: no checks yet">Unknown</span>
            {% endif %}
          </td>
          <td class="text-end">{{ '%.1f'|format(last.latency_ms) if last and last.latency_ms else '' }}</td>
          <td class="text-center">
            {% set is_reserved = (host.tags_json and 'reserved' in host.tags_json) %}
            {% set has_ports = (port_summaries and port_summaries.get(host.id)) %}
            {% set is_deprecated = (host.tags_json and 'deprecated' in host.tags_json) %}
            {% if is_reserved %}
              <span class="badge text-dark" data-flag="reserved" data-bs-toggle="tooltip" title="Address reserved">R</span>
            {% endif %}
            {% if has_ports %}
              <span class="badge text-dark ms-1" data-flag="ports" data-bs-toggle="tooltip" title="Ports: open ports were found">P</span>
            {% endif %}
            {% if is_deprecated %}
              <span class="badge text-light ms-1" data-flag="deprecated" data-bs-toggle="tooltip" title="Deprecated: host marked as deprecated">D</span>
            {% endif %}
          </td>
          <td class="text-end">
            <div class="d-flex justify-content-end align-items-center gap-1 flex-wrap">
              <form method="post" action="/hosts/{{ host.id }}/scan_ports" class="d-inline" title="Scan ports" aria-label="Scan ports">
                <button class="btn btn-sm btn-outline-info p-0 px-1" type="submit">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M10.442 10.442a1 1 0 0 1 1.415 0l3.9 3.9a1 1 0 0 1-1.414 1.415l-3.9-3.9a1 1 0 0 1 0-1.415z"/><path d="M6.5 12a5.5 5.5 0 1 1 0-11 5.5 5.5 0 0 1 0 11zm0-1A4.5 4.5 0 1 0 6.5 2a4.5 4.5 0 0 0 0 9z"/></svg>
                </button>
              </form>
              <form method="post" action="/hosts/{{ host.id }}/hostname/clear" class="d-inline" title="Clear hostname" aria-label="Clear hostname">
                <button class="btn btn-sm btn-outline-secondary" {% if not host.hostname %}disabled aria-disabled="true"{% endif %}>Clear Name</button>
              </form>
              <form method="post" action="/hosts/{{ host.id }}/unreserve" class="d-inline" title="Unreserve" aria-label="Unreserve">
                {% set is_reserved = (host.tags_json and 'reserved' in host.tags_json) %}
                <button class="btn btn-sm btn-outline-danger" {% if not is_reserved %}disabled aria-disabled="true"{% endif %}>
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V6H6v7.5a.5.5 0 0 1-1 0v-8z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2H5h6h2.5a1 1 0 0 1 1 1zM5 4v9h6V4H5zM4.118 2 4 2.059V2h8v.059L11.882 2H4.118z"/></svg>
                </button>
              </form>
              {# Removal is handled via Unreserve when host is down; no separate Remove button #}
              <form method="post" action="/hosts/{{ host.id }}/{% if host.tags_json and 'deprecated' in host.tags_json %}undeprecate{% else %}deprecate{% endif %}" class="d-inline" title="{% if host.tags_json and 'deprecated' in host.tags_json %}Revive{% else %}Retire{% endif %}" aria-label="{% if host.tags_json and 'deprecated' in host.tags_json %}Revive{% else %}Retire{% endif %}">
                <button class="btn btn-sm btn-outline-dark">
                  {% if host.tags_json and 'deprecated' in host.tags_json %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1"><path d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm10.97-2.03a.75.75 0 0 1 1.06 1.06L7.525 12.53a.75.75 0 0 1-1.08.02L3.525 9.62a.75.75 0 1 1 1.06-1.06l2.18 2.18 5.206-5.77z"/></svg>
                    Revive
                  {% else %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1"><path d="M8.982 1.566a1.5 1.5 0 0 0-1.964 0l-6 5.5A1.5 1.5 0 0 0 1.5 10h13a1.5 1.5 0 0 0 1.482-2.934l-6-5.5z"/></svg>
                    Retire
                  {% endif %}
                </button>
              </form>
              <button type="button" class="btn btn-sm btn-outline-secondary p-0 px-1 js-toggle-mac" data-id="{{ host.id }}" title="Edit MAC" aria-label="Edit MAC">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-9.5 9.5a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l9.5-9.5zM11.207 2 14 4.793 12.5 6.293 9.707 3.5 11.207 2zM8.5 4.707 11.293 7.5 4 14.793V12h-2.793L8.5 4.707z"/></svg>
              </button>
            </div>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
</div>
{% endblock %}
